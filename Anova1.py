# -*- coding: utf-8 -*-
"""Anova1

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1QUYm-Yr42wefQiIhvZshN2qOHISfXr5C

# ANOVA 1: S√çNTOMAS vs HORMONAS
# An√°lisis Estad√≠stico de Biomarcadores y Factores Asociados al SOP
# Equipo: Los SOP-timizadores


## OBJETIVO DEL AN√ÅLISIS ANOVA 1
Determinar si la presencia de s√≠ntomas cl√≠nicos (Pimples, Weight gain, Hair loss)
se asocia con diferencias significativas en los niveles hormonales (AMH, LH, FSH/LH ratio).

## ¬øPOR QU√â ANOVA Y NO SOLO CHI-CUADRADO?
Chi-cuadrado nos dijo que los s√≠ntomas est√°n ASOCIADOS con SOP (an√°lisis previo).
Ahora queremos ir m√°s profundo:
- ¬øLos s√≠ntomas tambi√©n se relacionan con ALTERACIONES HORMONALES espec√≠ficas?
- ¬øCu√°nto difieren los niveles hormonales entre grupos?
- ¬øEstas diferencias son cl√≠nicamente relevantes?

## PRUEBAS ESTAD√çSTICAS QUE USAREMOS:

1Ô∏è‚É£ PRUEBA DE LEVENE
   - Verifica si los grupos tienen varianzas similares
   - ANOVA asume varianzas iguales (homocedasticidad)
   - Si falla: ANOVA puede dar resultados incorrectos

2Ô∏è‚É£ ANOVA DE UN FACTOR (F-test)
   - Compara las medias de dos grupos
   - Prueba si las diferencias son estad√≠sticamente significativas
   - Da el p-valor para decidir sobre H0

3Ô∏è‚É£ ETA CUADRADO (Œ∑¬≤)
   - Mide el TAMA√ëO del efecto (no solo si existe)
   - Diferencia entre "significancia estad√≠stica" y "relevancia pr√°ctica"
   - Crucial para interpretaci√≥n cl√≠nica

## JUSTIFICACI√ìN CIENT√çFICA
- **Pimples vs AMH**: El acn√© puede estar relacionado con hiperandrogenismo,
  y AMH elevada es un marcador clave de SOP
- **Weight gain vs AMH**: Chi-cuadrado mostr√≥ la asociaci√≥n M√ÅS fuerte (œá¬≤=103.31),
  queremos validar si tambi√©n hay diferencias hormonales
- **Hair loss vs FSH/LH ratio**: La alopecia androgen√©tica puede relacionarse
  con desbalance FSH/LH caracter√≠stico de SOP
- **Pimples vs LH**: Los andr√≥genos (reflejados por LH alta) est√°n directamente
  asociados con acn√© en mujeres con SOP

## HIP√ìTESIS
H0: No hay diferencia significativa en los niveles hormonales entre grupos
    con y sin el s√≠ntoma
H1: Existe diferencia significativa en los niveles hormonales entre grupos
"""

import pandas as pd
import numpy as np
from scipy import stats
from scipy.stats import f_oneway, levene
import matplotlib.pyplot as plt
import seaborn as sns

# Configuraci√≥n
plt.style.use('seaborn-v0_8-darkgrid')
sns.set_palette("husl")
ALPHA = 0.05

"""### Carga de datos"""

df = pd.read_csv('PCOS_data_1.csv')
df['FSH/LH'] = df['FSH(mIU/mL)'] / df['LH(mIU/mL)']
df['FSH/LH'] = df['FSH/LH'].replace([np.inf, -np.inf], np.nan)

print("="*70)
print("üìä DATASET CARGADO")
print("="*70)
print(f"Total registros: {len(df)}")
print(f"Mujeres con SOP: {df['PCOS (Y/N)'].sum()}")
print(f"Mujeres sin SOP: {len(df) - df['PCOS (Y/N)'].sum()}")

def obtener_grupos(df, sintoma_col, hormona_col):
    """Extrae y limpia los dos grupos a comparar"""
    datos = df[[sintoma_col, hormona_col]].dropna()
    grupo_si = datos[datos[sintoma_col] == 1][hormona_col]
    grupo_no = datos[datos[sintoma_col] == 0][hormona_col]
    return grupo_si, grupo_no

def estadisticas_descriptivas(grupo_si, grupo_no, sintoma, hormona):
    """Muestra estad√≠sticas b√°sicas de ambos grupos"""
    print(f"\nüìä ESTAD√çSTICAS: {sintoma} vs {hormona}")
    print("-" * 70)
    print(f"CON s√≠ntoma:  n={len(grupo_si):3d} | Media={grupo_si.mean():7.3f} | DE={grupo_si.std():6.3f}")
    print(f"SIN s√≠ntoma:  n={len(grupo_no):3d} | Media={grupo_no.mean():7.3f} | DE={grupo_no.std():6.3f}")
    print(f"Diferencia:   {grupo_si.mean() - grupo_no.mean():+7.3f} ({abs((grupo_si.mean()-grupo_no.mean())/grupo_no.mean()*100):.1f}%)")

def prueba_levene(grupo_si, grupo_no):
    """Verifica homogeneidad de varianzas"""
    print(f"\nüî¨ LEVENE (Homogeneidad de varianzas)")
    print("   ‚Ä¢ Si p‚â•0.05 ‚Üí Varianzas iguales ‚úì (ANOVA v√°lido)")
    print("   ‚Ä¢ Si p<0.05 ‚Üí Varianzas diferentes ‚ö†Ô∏è (precauci√≥n)")

    stat, p = levene(grupo_si, grupo_no)
    print(f"   Resultado: p={p:.4f} ‚Üí {'‚úì OK' if p >= ALPHA else '‚ö†Ô∏è PRECAUCI√ìN'}")
    return p

def anova_test(grupo_si, grupo_no):
    """Realiza ANOVA y calcula tama√±o del efecto"""
    print(f"\nüìä ANOVA (Comparaci√≥n de medias)")

    # ANOVA
    f_stat, p_valor = f_oneway(grupo_si, grupo_no)

    # Eta cuadrado
    datos_completos = pd.concat([grupo_si, grupo_no])
    media_total = datos_completos.mean()
    ssb = len(grupo_si)*(grupo_si.mean()-media_total)**2 + len(grupo_no)*(grupo_no.mean()-media_total)**2
    sst = ((datos_completos - media_total)**2).sum()
    eta2 = ssb / sst

    print(f"   F={f_stat:.3f} | p={p_valor:.4e}")
    print(f"   Eta¬≤={eta2:.4f} ({'Peque√±o' if eta2<0.01 else 'Mediano' if eta2<0.06 else 'Grande'})")

    # Decisi√≥n
    if p_valor < ALPHA:
        print(f"   ‚úì SIGNIFICATIVO (p<0.05) ‚Üí Hay diferencia real")
    else:
        print(f"   ‚úó NO significativo (p‚â•0.05) ‚Üí Sin evidencia de diferencia")

    return f_stat, p_valor, eta2

def visualizar(grupo_si, grupo_no, sintoma, hormona, p_valor):
    """Crea visualizaciones compactas"""
    fig, axes = plt.subplots(1, 2, figsize=(12, 4))

    # Boxplot
    datos = pd.DataFrame({
        'Grupo': ['S√≠']*len(grupo_si) + ['No']*len(grupo_no),
        hormona: list(grupo_si) + list(grupo_no)
    })
    sns.boxplot(data=datos, x='Grupo', y=hormona, ax=axes[0], palette=['#FF6B6B','#4ECDC4'])
    axes[0].set_title(f'{sintoma} vs {hormona}', fontweight='bold')

    # Anotaci√≥n p-valor
    y_max = datos[hormona].max()
    texto_p = f"p={'<0.001***' if p_valor<0.001 else f'{p_valor:.3f}' + ('**' if p_valor<0.01 else '*' if p_valor<0.05 else ' ns')}"
    axes[0].text(0.5, y_max*1.05, texto_p, ha='center', fontweight='bold',
                bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.5))

    # Histograma
    axes[1].hist(grupo_si, bins=15, alpha=0.6, label='Con s√≠ntoma', color='#FF6B6B', edgecolor='black')
    axes[1].hist(grupo_no, bins=15, alpha=0.6, label='Sin s√≠ntoma', color='#4ECDC4', edgecolor='black')
    axes[1].axvline(grupo_si.mean(), color='red', linestyle='--', linewidth=2)
    axes[1].axvline(grupo_no.mean(), color='blue', linestyle='--', linewidth=2)
    axes[1].set_xlabel(hormona, fontweight='bold')
    axes[1].set_title('Distribuci√≥n comparativa', fontweight='bold')
    axes[1].legend()
    axes[1].grid(True, alpha=0.3)

    plt.tight_layout()
    plt.show()

def analizar_anova(df, sintoma_col, hormona_col, titulo, justificacion):
    """Funci√≥n principal que ejecuta an√°lisis completo"""
    print("\n\n" + "="*70)
    print(f"üî¨ {titulo}")
    print("="*70)
    print(f"üí° {justificacion}\n")

    # 1. Obtener datos
    grupo_si, grupo_no = obtener_grupos(df, sintoma_col, hormona_col)

    # 2. Estad√≠sticas descriptivas
    estadisticas_descriptivas(grupo_si, grupo_no, sintoma_col, hormona_col)

    # 3. Prueba de Levene
    levene_p = prueba_levene(grupo_si, grupo_no)

    # 4. ANOVA
    f_stat, p_valor, eta2 = anova_test(grupo_si, grupo_no)

    # 5. Visualizaci√≥n
    visualizar(grupo_si, grupo_no, sintoma_col, hormona_col, p_valor)

    return {
        'sintoma': sintoma_col,
        'hormona': hormona_col,
        'n_si': len(grupo_si),
        'n_no': len(grupo_no),
        'media_si': grupo_si.mean(),
        'media_no': grupo_no.mean(),
        'f_stat': f_stat,
        'p_valor': p_valor,
        'eta2': eta2,
        'levene_p': levene_p,
        'significativo': p_valor < ALPHA
    }

resultados = []

# AN√ÅLISIS 1: Pimples vs AMH
resultados.append(analizar_anova(
    df, 'Pimples(Y/N)', 'AMH(ng/mL)',
    titulo="AN√ÅLISIS 1: PIMPLES (Acn√©) vs AMH",
    justificacion="""El acn√© en mujeres con SOP est√° relacionado con hiperandrogenismo.
    AMH (Hormona Anti-M√ºlleriana) es un marcador clave de reserva ov√°rica y est√°
    elevada en SOP debido a la acumulaci√≥n de fol√≠culos antrales peque√±os. Queremos
    determinar si las mujeres con acn√© tienen niveles de AMH significativamente
    diferentes, lo que sugerir√≠a una relaci√≥n entre manifestaciones cut√°neas y
    disfunci√≥n ov√°rica."""
))

# AN√ÅLISIS 2: Weight Gain vs AMH
resultados.append(analizar_anova(
    df, 'Weight gain(Y/N)', 'AMH(ng/mL)',
    titulo="AN√ÅLISIS 2: WEIGHT GAIN (Ganancia de peso) vs AMH",
    justificacion="""La prueba de Chi-cuadrado revel√≥ que Weight Gain tiene la asociaci√≥n
    M√ÅS FUERTE con SOP (œá¬≤=103.31, p<0.001). Ahora queremos confirmar si esta
    asociaci√≥n tambi√©n se refleja en diferencias hormonales espec√≠ficas (AMH).
    La resistencia a la insulina, com√∫n en SOP, conduce tanto al aumento de peso
    como a alteraciones en la funci√≥n ov√°rica, lo que podr√≠a explicar niveles
    elevados de AMH en pacientes con ganancia de peso."""
))

# AN√ÅLISIS 3: Hair Loss vs FSH/LH
resultados.append(analizar_anova(
    df, 'Hair loss(Y/N)', 'FSH/LH',
    titulo="AN√ÅLISIS 3: HAIR LOSS (P√©rdida de cabello) vs FSH/LH Ratio",
    justificacion="""La alopecia androgen√©tica en mujeres con SOP est√° relacionada con
    el desbalance hormonal caracter√≠stico del s√≠ndrome. En SOP, el ratio FSH/LH
    t√≠picamente es bajo (< 1) debido a niveles elevados de LH. La p√©rdida de cabello
    puede ser una manifestaci√≥n externa de este desbalance hormonal. Evaluamos si
    las mujeres con alopecia presentan un ratio FSH/LH significativamente m√°s bajo,
    lo que indicar√≠a una relaci√≥n directa entre p√©rdida capilar y disfunci√≥n del
    eje hipot√°lamo-hip√≥fisis-ovario."""
))

# AN√ÅLISIS 4: Pimples vs LH
resultados.append(analizar_anova(
    df, 'Pimples(Y/N)', 'LH(mIU/mL)',
    titulo="AN√ÅLISIS 4: PIMPLES (Acn√©) vs LH",
    justificacion="""LH (Hormona Luteinizante) elevada estimula la producci√≥n de andr√≥genos
    (principalmente testosterona) en las c√©lulas tecales del ovario. Estos andr√≥genos
    son los responsables DIRECTOS del acn√© en mujeres con SOP al estimular las
    gl√°ndulas seb√°ceas. Esperamos encontrar niveles de LH significativamente m√°s
    altos en mujeres con acn√©, lo que confirmar√≠a el mecanismo fisiopatol√≥gico:
    LH elevada ‚Üí hiperandrogenismo ‚Üí manifestaciones cut√°neas (acn√©)."""
))

print("\n\n" + "="*70)
print("üìã TABLA RESUMEN - ANOVA 1: S√çNTOMAS vs HORMONAS")
print("="*70)

resumen = pd.DataFrame({
    'S√≠ntoma': [r['sintoma'] for r in resultados],
    'Hormona': [r['hormona'] for r in resultados],
    'n_Con': [r['n_si'] for r in resultados],
    'n_Sin': [r['n_no'] for r in resultados],
    'Media_Con': [f"{r['media_si']:.3f}" for r in resultados],
    'Media_Sin': [f"{r['media_no']:.3f}" for r in resultados],
    'F': [f"{r['f_stat']:.2f}" for r in resultados],
    'p-valor': [f"{r['p_valor']:.4e}" for r in resultados],
    'Œ∑¬≤': [f"{r['eta2']:.4f}" for r in resultados],
    'Signif.': ['‚úì' if r['significativo'] else '‚úó' for r in resultados]
})

print("\n", resumen.to_string(index=False))

# CONCLUSIONES
print("\n" + "="*70)
print("üéØ CONCLUSIONES FINALES")
print("="*70)

significativos = [r for r in resultados if r['significativo']]
print(f"\n‚úì An√°lisis significativos: {len(significativos)}/4")

if significativos:
    print("\nüìä HALLAZGOS CLAVE:")
    for r in significativos:
        diff = r['media_si'] - r['media_no']
        print(f"\n‚Ä¢ {r['sintoma']} ‚Üí {r['hormona']}")
        print(f"  Diferencia: {diff:+.3f} | Œ∑¬≤={r['eta2']:.4f} | p={r['p_valor']:.4e}")

print("\n" + "="*70)
print("‚úÖ ANOVA 1 COMPLETADO | Fecha: 3-Nov-2024 | Responsable: Paul")
print("="*70)